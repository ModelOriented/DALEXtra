---
title: "ChampionChallenger"
author: "DALEXtra"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true  
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE, message=FALSE, warning=TRUE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r}
library("auditor")
```

# Measures 

```{r}
confusionmatrix <- function(explainer) {
  yhat <- as.numeric(explainer$y_hat > 0.5)
  TP <- sum(yhat[yhat == 1] == explainer$y[yhat == 1])
  FP <- length(yhat[yhat == 1]) - TP
  TN <- sum(yhat[yhat == 0] == explainer$y[yhat == 0])
  FN <- length(yhat[yhat == 0]) - TN
  list(
    "TP" = TP,
    "FP" = FP,
    "TN" = TN,
    "FN" = FN
  )
}

new_scores <- list(
  "1-auc" = function(au) {
    1 - score(au, score = "auc")$score
  },
  "1-acc" = function(au) {
    conf <- confusionmatrix(au)
    1 - (conf$TP + conf$TN) / (conf$TP + conf$FP + conf$TN + conf$FN)
  },
  "1-precission" = function(au) {
    conf <- confusionmatrix(au)
    1 - conf$TP / (conf$TP + conf$FP)
  },
  "1-recall" = function(au) {
    conf <- confusionmatrix(au)
    1 - conf$TP / (conf$TP + conf$FN)
  },
  "1-specificity" = function(au) {
    conf <- confusionmatrix(au)
    1 - conf$TN / (conf$TN + conf$FP)
  },
  "1-F1" = function(au) {
    conf <- confusionmatrix(au)
    (2 * (conf$TP / (conf$TP + conf$FP)) * (conf$TP / (conf$TP + conf$FN))) /
      (conf$TP / (conf$TP + conf$FN) + conf$TP / (conf$TP + conf$FP))
  }
)
plot(auditor::model_performance(champion, score = NULL, new_score = new_scores), auditor::model_performance(challenger, score = NULL, new_score = new_scores))


```

# Scores comparison

Sometimes mesuares or even graphics that are presented below, are not sufficient to judge which model is better. Therefore here we have some scores. DW score and Runs score are based on Durbin-Watson and Runs test statistics.

```{r}
scores <- data.frame(c(score_dw(champion)$score, score_runs(champion)$score), c(score_dw(challenger)$score, score_runs(challenger)$score))
colnames(scores) <- c(champion$label, challenger$label)
rownames(scores) <- c("Durbin-Watson", "Runs")
scores
```

# Response comparison

```{r}
library(rpart)
testdata_champion <-
  cbind(champion$data,
        "survived" = as.numeric(champion$y_hat > 0.5))
testdata_challenger <-
  cbind(challenger$data,
        "survived" = as.numeric(challenger$y_hat > 0.5))
yhats <- data.frame(
  "champion" = as.numeric(champion$y_hat > 0.5),
  "challenger" = as.numeric(challenger$y_hat > 0.5)
)

model_champion <-
  rpart(survived ~ .,
        data = testdata_champion,
        control = control)

model_challenger <-
  rpart(survived ~ .,
        data = testdata_challenger,
        control = control)

datasets_champion <- lapply(sort(unique(model_champion$where)), function(x){
  yhats[model_champion$where == x,]
})
names_champion <- row.names(model_champion$frame[model_champion$frame$var == "<leaf>",])
rules_champion <- rpart.plot::rpart.rules(model_champion) 
rules_champion  <- rules_champion[names_champion,]

datasets_challenger<- lapply(sort(unique(model_challenger$where)), function(x){
  yhats[model_challenger$where == x,]
})
names_challenger <- row.names(model_challenger$frame[model_challenger$frame$var == "<leaf>",])
rules_challenger <- rpart.plot::rpart.rules(model_challenger) 
rules_challenger <- rules_challenger[names_challenger,]

entropy <- function(x) {
  if (sum(0 == x) == 0) {
    ret_0 <- 0
  } else {
    ret_0 <- (sum(0 == x) / length(x)) * log2(sum(0 == x) / length(x))
  }
  if (sum(1 == x) == 0) {
    ret_1 <- 0
  } else {
    ret_1 <- (sum(1 == x) / length(x)) * log2(sum(1 == x) / length(x))
  }


  - ret_0 - ret_1
}

loss_function <- function(X){
  rows <- sum(apply(X, MARGIN = 1, entropy))
  columns <- sum(apply(X, MARGIN = 2, entropy))
  rows/nrow(X) - columns/ncol(X)
}

scores_champion <- sapply(datasets_champion, loss_function)
scores_challenger <- sapply(datasets_challenger, loss_function)
if (max(scores_champion) >= max(scores_challenger)) {
  controversial_data <-
    cbind(champion$data, "survived" = champion$y_hat)[row.names(datasets_champion[[which.max(scores_champion)]]),]
  controversial_data_rule <-
    paste0(rules_champion[which.max(scores_champion), -(1:2)], collapse = " ")
  plot_data <-
    cbind(champion$data, "survived" = challenger$y_hat)[row.names(datasets_champion[[which.max(scores_champion)]]),]
} else{
  controversial_data <-
    cbind(challenger$data, "survived" = challenger$y_hat)[row.names(datasets_challenger[[which.max(scores_challenger)]]),]
  controversial_data_rule <-
    paste0(rules_challenger[which.max(scores_challenger), -(1:2)], collapse = " ")
  plot_data <-
    cbind(challenger$data, "survived" = champion$y_hat)[row.names(datasets_challenger[[which.max(scores_challenger)]]),]
}

controversial_data_rule
as.data.frame(controversial_data)

```


# Residual comparison

## Autocorrealation of residuals

```{r}
champion_model_residual <- model_residual(champion)
challenger_model_residual <- model_residual(challenger)
plot_autocorrelation(champion_model_residual, challenger_model_residual)
```

## Receiver Operating Characteristic (ROC) Curve

```{r}
champion_model_evaluation <- model_evaluation(champion)
challenger_model_evaluation <- model_evaluation(challenger)
plot_roc(champion_model_evaluation, challenger_model_evaluation)
```

## Prediction vs variable

```{r}
library(ggplot2)
if(is.null(variable)) {
  print(plot_prediction(champion_model_residual, challenger_model_residual, variable = variable)+
            geom_point(data = plot_data, aes(x = plot_data[,var], y = plot_data$survived), color='red')+
            geom_point(data = controversial_data, aes(x = controversial_data[,var], y = controversial_data$survived), color='orange'))
} else {
  for (var in variable) {
    print(plot_prediction(champion_model_residual, challenger_model_residual, variable = var)+
            geom_point(data = plot_data, aes(x = plot_data[,var], y = plot_data$survived), color='red')+
            geom_point(data = controversial_data, aes(x = controversial_data[,var], y = controversial_data$survived), color='orange'))
  }
}

```

## ResidualBoxplot

```{r}
plot_residual_boxplot(champion_model_residual, challenger_model_residual)
```

## Residual Density

```{r}
plot_residual_density(champion_model_residual, challenger_model_residual)
```

## LIFT curve

```{r}
plot_lift(champion_model_evaluation, challenger_model_evaluation)
```

